name: Release WordPress Plugin

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          extensions: mbstring, intl, curl
          tools: composer, wp-cli

      - name: Get the version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify version matches
        run: |
          WP_VERSION=$(grep -i "^[[:space:]]*\* *Version:" lens-calculator.php | head -1 | awk -F': ' '{gsub(/\r|^[ \t]+|[ \t]+$/, "", $2); print $2}')
          README_VERSION=$(grep -i "^[[:space:]]*Stable tag:" readme.txt | head -1 | awk -F': ' '{gsub(/\r|^[ \t]+|[ \t]+$/, "", $2); print $2}')
          PKG_VERSION=$(node -p "require('./package.json').version.trim()")
          
          if [ "$WP_VERSION" != "${{ env.VERSION }}" ] || [ "$README_VERSION" != "${{ env.VERSION }}" ] || [ "$PKG_VERSION" != "${{ env.VERSION }}" ]; then
            echo "Error: Version mismatch detected!"
            echo "Tag version: ${{ env.VERSION }}"
            echo "Plugin version: $WP_VERSION"
            echo "readme.txt version: $README_VERSION"
            echo "package.json version: $PKG_VERSION"
            exit 1
          fi

          echo "All version numbers match: ${{ env.VERSION }}"

      - name: Run build process
        run: npm run build

      - name: Create ZIP file
        run: |
          mkdir -p build
          git archive --format=zip --output=build/lens-calculator-${{ env.VERSION }}.zip HEAD

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/lens-calculator-${{ env.VERSION }}.zip
          name: CCTV Lens Calculator ${{ env.VERSION }}
          draft: false
          prerelease: false
          body: |
            # CCTV Lens Calculator for WordPress ${{ env.VERSION }}

            ## What's Changed
            See the [changelog](https://github.com/pgroot91/lens-calculator/blob/master/readme.txt).

            ## Installation
            1. Download the ZIP file from this release
            2. Upload and activate the plugin in your WordPress installation

            ## Notes
            - Compatible with WordPress 5.3+
            - Requires PHP 7.4.30+ (tested also with PHP 8.1)
            - Always backup your site before upgrading
