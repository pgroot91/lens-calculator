name: Unit Tests (PHP)

on:
  push:
    branches:
      - "master"
  pull_request:
    branches:
      - "master"

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        wpVersion: ["6.9"]
        phpVersion: ["7.4", "8.0", "8.3", "8.5"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Node.js dependencies
        run: npm ci

      - name: Configure WordPress
        run: |
          echo '{"core": "WordPress/WordPress#tags/${{ matrix.wpVersion }}","phpVersion": "${{ matrix.phpVersion }}" }' > .wp-env.override.json

      - name: Install Composer dependencies
        run: composer install

      - name: Start WordPress Environment
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: npm run env:start -- --debug

      - name: Wait for WordPress to be ready
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8889 | grep -q "WordPress"; then
              echo "WordPress is ready";
              break;
            fi
            echo "Waiting for WordPress... ($i/30)";
            sleep 5;
          done

      - name: Verify WordPress and PHP versions
        run: |
          echo "=== WordPress PHP Info ==="
          npx wp-env run cli php -v

          echo "=== WordPress Version ==="
          npx wp-env run cli wp core version

          echo "=== Verify matches matrix ==="
          wp_version=$(npx wp-env run cli wp core version)
          if [ "$wp_version" != "${{ matrix.wpVersion }}" ]; then
            echo "❌ WordPress version mismatch! Expected ${{ matrix.wpVersion }}, got $wp_version"
            exit 1
          else
            echo "✅ WordPress version matches matrix: $wp_version"
          fi

      - name: Run unit tests
        run: npm run test:php

      - name: Stop WordPress environment
        run: npm run env:stop
